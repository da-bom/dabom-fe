name: Issue Branch Creator

on:
  issues:
    types: [opened]

jobs:
  create_branch:
    runs-on: ubuntu-latest
    if: github.event.issue.user.login != 'github-actions[bot]'

    permissions:
      contents: write
      issues: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ github.token }}

      - name: Parse branch name from issue body
        id: parse
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.issue.body || '';

            // ì´ìŠˆ ë³¸ë¬¸ì—ì„œ ë¸Œëœì¹˜ëª… í•„ë“œ íŒŒì‹±
            const branchMatch = body.match(/### ğŸŒ³ ë¸Œëœì¹˜ëª…[^\n]*\n\n([^\n]+)/);
            if (!branchMatch) {
              core.setFailed('ë¸Œëœì¹˜ëª… í•„ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
              return;
            }

            const branchName = branchMatch[1].trim();
            core.info(`íŒŒì‹±ëœ ë¸Œëœì¹˜ëª…: ${branchName}`);

            // ì»¨ë²¤ì…˜ íŒ¨í„´ ê²€ì¦: {type}/DABOM-{number} ë˜ëŠ” {type}/DABOM-{number}-{slug}
            const validTypes = [
              'feat', 'fix', 'refactor', 'design', 'style', 'docs',
              'test', 'chore', 'init', 'rename', 'remove', 'cicd', 'hotfix'
            ];
            const pattern = new RegExp(`^(${validTypes.join('|')})/DABOM-\\d+`);

            if (!pattern.test(branchName)) {
              core.setFailed(
                `ë¸Œëœì¹˜ëª…ì´ ì»¨ë²¤ì…˜ì— ë§ì§€ ì•ŠìŠµë‹ˆë‹¤: ${branchName}\n` +
                `ì˜ˆìƒ í˜•ì‹: feat/DABOM-00, fix/DABOM-00`
              );
              return;
            }

            const type = branchName.match(/^(\w+)\//)[1];
            core.setOutput('branch', branchName);
            core.setOutput('type', type);

      - name: Add type label to issue
        if: steps.parse.outputs.type
        uses: actions/github-script@v7
        with:
          script: |
            const type = '${{ steps.parse.outputs.type }}';
            const issueNumber = context.payload.issue.number;

            // ë¼ë²¨ì´ ì—†ìœ¼ë©´ ìƒì„±
            const labelColors = {
              feat: '0E8A16', fix: 'D93F0B', refactor: '1D76DB',
              design: 'F9D0C4', style: 'FEF2C0', docs: '0075CA',
              test: 'BFD4F2', chore: 'D4C5F9', init: '5319E7',
              rename: 'C2E0C6', remove: 'B60205', cicd: 'FBCA04',
              hotfix: 'E11D48'
            };

            try {
              await github.rest.issues.getLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                name: type
              });
            } catch (e) {
              if (e.status === 404) {
                await github.rest.issues.createLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: type,
                  color: labelColors[type] || 'EDEDED'
                });
              }
            }

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              labels: [type]
            });
            core.info(`âœ… ë¼ë²¨ ì¶”ê°€: ${type}`);

      - name: Create and push branch
        if: steps.parse.outputs.branch
        run: |
          BRANCH_NAME="${{ steps.parse.outputs.branch }}"
          ISSUE_NUMBER="${{ github.event.issue.number }}"

          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          git checkout -b "$BRANCH_NAME"
          git push origin "$BRANCH_NAME"

          gh issue comment "$ISSUE_NUMBER" --body "ğŸŒ¿ ë¸Œëœì¹˜ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤: \`$BRANCH_NAME\`"
        env:
          GITHUB_TOKEN: ${{ github.token }}
