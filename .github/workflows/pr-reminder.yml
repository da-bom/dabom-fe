name: PR Reminder

on:
  schedule:
    # ë§¤ 2ì‹œê°„ë§ˆë‹¤ ì‹¤í–‰ (UTC ê¸°ì¤€)
    - cron: '0 */2 * * *'
  workflow_dispatch:

jobs:
  pr-reminder:
    runs-on: ubuntu-latest

    permissions:
      pull-requests: write
      issues: write
      contents: read

    steps:
      - name: Add reminder label & comment to inactive PRs
        uses: actions/stale@v9
        with:
          # ğŸ·ï¸ ì¤‘ë¦½ì  ë¦¬ë§ˆì¸ë“œ ë¼ë²¨
          stale-pr-label: 'remind-needed'

          # ğŸ’¬ PR ì½”ë©˜íŠ¸ (ì‘ì„±ì + ë¦¬ë·°ì–´ ëª¨ë‘ ëŒ€ìƒ)
          stale-pr-message: |
            ğŸ‘‹ **PR ë¦¬ë§ˆì¸ë“œ ì•Œë¦¼ì…ë‹ˆë‹¤**

            ì´ PRì´ ëª‡ ì‹œê°„ ë™ì•ˆ ì—…ë°ì´íŠ¸ë˜ì§€ ì•Šì•˜ì–´ìš”.

            - ğŸ™‹ **PR ì‘ì„±ì**: ì¶”ê°€ ì‘ì—… ì¤‘ì´ê±°ë‚˜ ì„¤ëª…ì´ í•„ìš”í•˜ë©´ ì½”ë©˜íŠ¸ ë‚¨ê²¨ì£¼ì„¸ìš”
            - ğŸ‘€ **ë¦¬ë·°ì–´ / íŒ€ì›**: ì´ë¯¸ ë´¤ë‹¤ë©´ LGTM í•œ ì¤„ë„ ì¢‹ì•„ìš”!

            ë°”ì˜ì‹¤ ìˆ˜ ìˆë‹¤ëŠ” ì  ì´í•´í•©ë‹ˆë‹¤ ğŸ™
            ë‹¤ë§Œ ì‘ì€ í•œ ì¤„ì´ PR íë¦„ì„ ì‚´ë ¤ì¤˜ìš” ğŸ™‚

          # â±ï¸ 4ì‹œê°„ (4 / 24 day)
          days-before-pr-stale: 0.1667
          days-before-pr-close: -1  # âŒ ìë™ close ì—†ìŒ

          # IssueëŠ” ì²˜ë¦¬í•˜ì§€ ì•ŠìŒ
          days-before-issue-stale: -1
          days-before-issue-close: -1

          # ì—…ë°ì´íŠ¸ë˜ë©´ ë¦¬ë§ˆì¸ë“œ ìë™ í•´ì œ
          remove-stale-when-updated: true

          # ì œì™¸ ëŒ€ìƒ
          exempt-draft-pr: true
          exempt-pr-labels: 'wip,blocked,do-not-remind'

          operations-per-run: 20

      - name: Notify Slack - PR Reminder (with PR links)
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          PR_LIST=$(curl -fsS \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${{ github.repository }}/issues?state=open&labels=remind-needed" \
            | jq -r '.[] | select(.pull_request) |
              "- <\(.html_url)|#\(.number)> \(.title)\n  ğŸ‘¤ ì‘ì„±ì: @\(.user.login)"')

          # ê³µë°±/ë¹ˆì¤„ë§Œ ìˆëŠ” ê²½ìš° ì œê±°í•´ì„œ ì§„ì§œ ë¹„ì—ˆëŠ”ì§€ íŒë‹¨
          PR_LIST_TRIMMED=$(printf "%s" "$PR_LIST" | sed '/^[[:space:]]*$/d')

          if [ -z "$PR_LIST_TRIMMED" ]; then
            echo "ğŸ“­ ë¦¬ë§ˆì¸ë“œ ëŒ€ìƒ PRì´ ì—†ìŠµë‹ˆë‹¤. ìŠ¬ë™ ë©”ì‹œì§€ë¥¼ ë³´ë‚´ì§€ ì•Šê³  ì¢…ë£Œí•©ë‹ˆë‹¤."
            exit 0
          fi
            MESSAGE="*< ğŸ‘€ PR Reminder >*

          ìµœê·¼ *ì—…ë°ì´íŠ¸ê°€ ì—†ëŠ” PR* ì´ ìˆì–´ìš” â³
          ì§§ê²Œë¼ë„ í™•ì¸ ë¶€íƒë“œë ¤ìš”!

          â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          ğŸ“Œ *ëŒ€ìƒ PR*
          $PR_LIST
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”

          ğŸ‘‰ *PR ì‘ì„±ì*
          - ì§„í–‰ ìƒí™© ê³µìœ  ë˜ëŠ” ì¶”ê°€ ì„¤ëª… ë¶€íƒë“œë ¤ìš”

          ğŸ‘‰ *ë¦¬ë·°ì–´ / íŒ€ì›*
          - ì´ë¯¸ ë´¤ë‹¤ë©´ ğŸ‘ LGTM í•œ ì¤„ì´ë©´ ì¶©ë¶„í•´ìš”!


          ğŸ™ ì‘ì€ ì•¡ì…˜ í•˜ë‚˜ê°€ PR íë¦„ì„ ì‚´ë ¤ì¤˜ìš”"

          # Slackìœ¼ë¡œ ì „ì†¡ (JSON ì•ˆì „í•˜ê²Œ)
          curl -fsS -X POST -H 'Content-type: application/json' \
            --data "$(jq -n --arg text "$MESSAGE" '{text: $text}')" \
            "$SLACK_WEBHOOK_URL"
